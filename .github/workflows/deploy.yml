name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main # ç¡®ä¿è¿™æ˜¯æ‚¨çš„ä¸»åˆ†æ”¯å

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Inject Firebase Config via Python ğŸ’‰
        env:
          FIREBASE_CONFIG: ${{ secrets.FIREBASE_CONFIG }}
          FIREBASE_AUTH_TOKEN: ${{ secrets.FIREBASE_AUTH_TOKEN }}
        run: |
          python -c "
          import os
          import sys

          html_file_path = 'index.html' # ç¡®ä¿è¿™æ˜¯æ‚¨çš„HTMLæ–‡ä»¶å
          placeholder = ''

          firebase_config = os.environ.get('FIREBASE_CONFIG')
          auth_token = os.environ.get('FIREBASE_AUTH_TOKEN')

          if not firebase_config:
              print('::error title=Secret Missing::FIREBASE_CONFIG secret is not set!')
              sys.exit(1)

          # The config is a JSON object, the token is a string
          # This creates the script tag to be injected into the HTML
          js_block = f\"<script>window.__firebase_config = {firebase_config}; window.__initial_auth_token = '{auth_token}';<\/script>\"

          try:
              with open(html_file_path, 'r', encoding='utf-8') as f:
                  content = f.read()
          except FileNotFoundError:
              print(f'::error title=File Not Found::Cannot find the file {html_file_path} in the repository.')
              sys.exit(1)

          if placeholder not in content:
              print(f'::error title=Placeholder Missing::Placeholder \"{placeholder}\" not found in {html_file_path}! Make sure your HTML file is up to date.')
              sys.exit(1)
              
          new_content = content.replace(placeholder, js_block)

          with open(html_file_path, 'w', encoding='utf-8') as f:
              f.write(new_content)

          print('Secrets successfully injected into the HTML file.')
          "
          
      - name: Deploy ğŸš€
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
