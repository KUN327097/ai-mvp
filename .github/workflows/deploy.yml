name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main # ç¡®ä¿è¿™æ˜¯æ‚¨çš„ä¸»åˆ†æ”¯å

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ğŸ›ï¸
        uses: actions/checkout@v3

      - name: Inject Firebase Config via Python ğŸ’‰
        env:
          FIREBASE_CONFIG: ${{ secrets.FIREBASE_CONFIG }}
        run: |
          python -c "
          import os
          import sys
          import json

          html_file_path = 'index.html' 
          placeholder = ''

          firebase_config_str = os.environ.get('FIREBASE_CONFIG', '').strip()

          if not firebase_config_str:
              print('::error title=Secret Missing::FIREBASE_CONFIG secret is not set!')
              sys.exit(1)
          
          # éªŒè¯ secret æ˜¯å¦ä¸ºæœ‰æ•ˆçš„ JSON
          try:
              json.loads(firebase_config_str)
          except json.JSONDecodeError:
              print(f'::error title=Invalid JSON::FIREBASE_CONFIG secret is not a valid JSON object. Please check what you pasted in GitHub Secrets.')
              sys.exit(1)

          # å°†é…ç½®ä¿¡æ¯å®‰å…¨åœ°åŒ…è£…æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œäº¤ç”±å®¢æˆ·ç«¯è§£æ
          js_block = f\"<script>try {{ window.__firebase_config = JSON.parse('{firebase_config_str}'); }} catch (e) {{ console.error('Failed to parse Firebase config:', e); document.body.innerHTML = 'Firebaseé…ç½®ä¿¡æ¯æ ¼å¼é”™è¯¯ï¼Œè¯·æ£€æŸ¥GitHub Secretsã€‚'; }}<\/script>\"

          try:
              with open(html_file_path, 'r', encoding='utf-8') as f:
                  content = f.read()
          except FileNotFoundError:
              print(f'::error title=File Not Found::Cannot find {html_file_path}.')
              sys.exit(1)

          if placeholder not in content:
              print(f'::error title=Placeholder Missing::Placeholder not found in {html_file_path}.')
              sys.exit(1)
              
          new_content = content.replace(placeholder, js_block)

          with open(html_file_path, 'w', encoding='utf-8') as f:
              f.write(new_content)

          print('Firebase config successfully and safely injected.')
          "
          
      - name: Deploy ğŸš€
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
