name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main # 确保这是您的主分支名

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3

      - name: Inject Firebase Config via Python 💉
        env:
          FIREBASE_CONFIG: ${{ secrets.FIREBASE_CONFIG }}
        run: |
          python -c "
          import os
          import sys
          import json

          html_file_path = 'index.html' 
          placeholder = ''

          firebase_config_str = os.environ.get('FIREBASE_CONFIG', '').strip()

          if not firebase_config_str:
              print('::error title=Secret Missing::FIREBASE_CONFIG secret is not set!')
              sys.exit(1)
          
          # 验证 secret 是否为有效的 JSON
          try:
              json.loads(firebase_config_str)
          except json.JSONDecodeError:
              print(f'::error title=Invalid JSON::FIREBASE_CONFIG secret is not a valid JSON object. Please check what you pasted in GitHub Secrets.')
              sys.exit(1)

          # 将配置信息安全地包装成一个字符串，交由客户端解析
          js_block = f\"<script>try {{ window.__firebase_config = JSON.parse('{firebase_config_str}'); }} catch (e) {{ console.error('Failed to parse Firebase config:', e); document.body.innerHTML = 'Firebase配置信息格式错误，请检查GitHub Secrets。'; }}<\/script>\"

          try:
              with open(html_file_path, 'r', encoding='utf-8') as f:
                  content = f.read()
          except FileNotFoundError:
              print(f'::error title=File Not Found::Cannot find {html_file_path}.')
              sys.exit(1)

          if placeholder not in content:
              print(f'::error title=Placeholder Missing::Placeholder not found in {html_file_path}.')
              sys.exit(1)
              
          new_content = content.replace(placeholder, js_block)

          with open(html_file_path, 'w', encoding='utf-8') as f:
              f.write(new_content)

          print('Firebase config successfully and safely injected.')
          "
          
      - name: Deploy 🚀
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
