name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main # 确保这是您的主分支名

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout 🛎️
        uses: actions/checkout@v3

      - name: Inject Firebase Config via Python 💉
        env:
          # 我们只需要 config, 不再需要 auth token
          FIREBASE_CONFIG: ${{ secrets.FIREBASE_CONFIG }}
        run: |
          python -c "
          import os
          import sys

          html_file_path = 'index.html' 
          placeholder = ''

          firebase_config = os.environ.get('FIREBASE_CONFIG')

          if not firebase_config:
              print('::error title=Secret Missing::FIREBASE_CONFIG secret is not set!')
              sys.exit(1)

          # 只注入config, 登录将完全通过匿名方式进行
          js_block = f\"<script>window.__firebase_config = {firebase_config};<\/script>\"

          try:
              with open(html_file_path, 'r', encoding='utf-8') as f:
                  content = f.read()
          except FileNotFoundError:
              print(f'::error title=File Not Found::Cannot find {html_file_path}.')
              sys.exit(1)

          if placeholder not in content:
              print(f'::error title=Placeholder Missing::Placeholder not found in {html_file_path}.')
              sys.exit(1)
              
          new_content = content.replace(placeholder, js_block)

          with open(html_file_path, 'w', encoding='utf-8') as f:
              f.write(new_content)

          print('Firebase config successfully injected.')
          "
          
      - name: Deploy 🚀
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./
